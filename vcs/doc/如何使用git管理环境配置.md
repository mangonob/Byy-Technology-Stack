## 如何使用git管理环境配置



作者：mangonob@qq.com

版本：0.1

更新日期：2018年3月14日



> 本文档描述如何使用版本控制来管理多环境配置，在软件的生命周期中经常需要在代码中切换不同的配置信息（例如：请求的域名，打包的名称，集成第三方平台的Key等在不同环境下具有差异化的内容），除非平台本身提供了比较好的配置管理方案（比如编译时通过命令行指定环境参数），否则需要开发者自己来维护不同的环境配置。



> 本文档所描述的通过版本控制来管理多环境的方法并不会与**gitflow**定义的规范冲突，可以视作**gitflow**的补充。



#### 符号约定

**branchA** -> **branchB**: 表示将**branchA**分支合并到**branchB**分支。



#### 问题描述

开发过程中手动修改环境配置相关的代码容易出错，也为开发者带来不必要的工作量。如果在上线的代码里，写上了测试的配置，将会有不可预期的风险。



#### 解决方案

通过定义`环境分支`来维护不同环境之间配置的差异，从不同的`环境分支`中来进行**开发/测试/发布**任务。



#### 环境分支

环境分支是从**develop**分支切出的分支，环境分支命名需要遵循：**env/\<环境名称\>**的规则，例如测试环境的分支名可以命名为**env/test**，生产环境的名称可以命名为**env/release**，前缀**env**需要强制遵循，**环境名称**则根据实际开发过程中的需求进行定义，没有强制规定。



> 环境分支是从develop分支切出的，环境分支使用之前需要将develop的代码并入，只会出现从develop分支到env/\*分支的合并，不允许将env/\*分支的代码合并到develop分支。



#### 使用示例

1. 假设平台的配置信息写在**configure.txt**文件中，**develop**分支上该文件的内容如下

   ```javascript
   ////
   //// configure.txt
   // 
   
   var main_domain = "https://devhwsc.handeson.com"
   
   var aliPay_key = "183a9e9f25c9"
   ```

   

   假设现有如下的环境配置

   |      | 域名 | 支付宝密钥 |
   | :----: | :--: | :--------: |
   | 开发环境 | devhwsc.handeson.com | 183a9e9f25c9 |
   | UAT环境 | uatapi.handeson.com | 916e6d02583 |
   | 生产环境 | hwscapi.handeson.com | 07795ee6e0c |

   

2. 从**develop**分支切出UAT环境所使用的分支**env/test**，以及生产环境所使用的分支**env/release**，一般开发环境的分支不需要单独建立，因为通常**develop**分支上的配置是开发阶段中最常用的配置。**develop**分支是开发分支，自然也是开发环境分支。

   

3. 在**env/test**，**env/release**分支上，将相应的配置信息修改成需要的内容，并提交。保持各个环境分支上均有需要的配置信息。

   

4. 除了第3步中所做的修改需要在环境分支上提交之外，**env/\***分支上是不应该做任何提交的，也就是不要在**env/\***分支上写代码。同**gitflow**规范所描述，大部分的工作内容主要集中在开发分支，以及特性分支上，而环境分支只是用来管理一些细小的差异，而不会涉及业务。

   

5. 环境分支除了可以管理域名配置等差异外，还可以行使更多的职能，例如在开发阶段，测试阶段，不希望启用Bugly来监控bug，只需要在生产环境上开启，使用环境分支是可以做到这一点的。如果需要的话，甚至可以让特定的类或者文件只需要在特定的环境上出现。具体怎么使用，由开发者定夺，环境分支的核心是：**管理不同环境之间的差异，所谓的差异可能是代码里几个字符串的不同，也可以是文件是否存在的差异**

   

6. 场景及实践

   【场景一】：特性分支**feature/featureA**需要在UAT环境上进行测试。

   【实践】：切到**env/test**分支，通过**develop** -> **env/test**获取**develop**分支上的工作内容，从**env/test**分支上切出一个分支**test/uat**（这里的分支名称可以随便起），通过**feature/featureA** -> **test/uat**并入需要测试的特性，然后在**test/uat**分支上打测试包，这时所交付的代码综合了**develop**分支上的业务代码，以及**env/test**分支上针对UAT环境的个性化配置（这里之所以需要**test/uat**分支，而不是直接**feature/featureA** -> **env/test**分支然后直接使用**env/test**分支打测试包，是因为可能会遇到之后需要单独测试其他的特性的情况，或其他不可预料的复杂情况）。

   

   

   【场景二】：需要发布的特性分支已经测试通过，并合并到**develop**分支上，需要发布到生产环境。

   【实践】：切到**env/release**分支，通过**develop** -> **env/release**获取需要发布的工作内容，从**env/release**分支切出发布分支**release/\<版本号\>**，使用发布分支进行发布。这时的发布分支综合了**develop**分支上的业务代码，以及生产环境的配置。

